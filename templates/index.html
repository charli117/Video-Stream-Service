<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>CVTE RES Screen Display Anomaly Analysis</title>
<!--?    <link rel="stylesheet" href="{{ url_for('static', filename='./css/style.css') }}">-->

    <style>
        /* 添加Font Awesome图标支持 */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .controls {
            margin: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            width: 80%;
            max-width: 600px;
        }
        .camera-select {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        select {
            padding: 5px;
            font-size: 16px;
            min-width: 200px;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .video-container {
            margin: 20px;
            max-width: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .video-container img {
            max-width: 100%;
            height: auto;
            object-fit: contain;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        #refreshButton {
            margin-left: 10px;
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #refreshButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        /* 添加Font Awesome图标支持 */
    </style>
</head>
<body>
    <div class="container">
        <h1>CVTE RES Screen Display Anomaly Analysis</h1>

        <div class="controls">
            <div class="camera-select">
                <select id="cameraSelect">
                    <option value="">Loading cameras...</option>
                </select>
                <button id="switchButton" onclick="switchCamera()" disabled>Switch Camera</button>
                <button id="refreshButton" onclick="loadCameras()">
                    <i class="fas fa-sync"></i> Refresh List
                </button>
            </div>
            <div id="error" class="error" style="display: none;"></div>
        </div>

        <div class="video-container">
            <img id="videoFeed" src="{{ url_for('main.video_feed') }}" alt="Video Feed">
        </div>

        <script>
            // 优化视频流重连
            function setupVideoStream() {
                const videoFeed = document.getElementById('videoFeed');

                videoFeed.onerror = function () {
                    // 如果加载失败，等待后重试
                    setTimeout(() => {
                        videoFeed.src = "{{ url_for('main.video_feed') }}?" + new Date().getTime();
                    }, 1000);
                };
            }

            setupVideoStream();
        </script>

        <div class="status" id="status">
            <p>Status: Loading...</p>
            <p>Camera: Loading...</p>
            <p>Resolution: Loading...</p>
            <p>FPS: Loading...</p>
        </div>
    </div>

    <script>
        let currentCamera = null;

        async function loadCameras() {
            try {
                const refreshButton = document.getElementById('refreshButton');
                const switchButton = document.getElementById('switchButton');

                // 禁用按钮，显示加载状态
                refreshButton.disabled = true;
                switchButton.disabled = true;

                const response = await fetch("{{ url_for('main.list_cameras') }}");
                const data = await response.json();

                const select = document.getElementById('cameraSelect');
                select.innerHTML = '';

                // 使用data.cameras而不是直接使用返回数据
                if (!data.cameras || data.cameras.length === 0) {
                    select.innerHTML = '<option value="">No cameras found</option>';
                    return;
                }

                // 更新当前摄像头
                currentCamera = data.current;

                // 遍历cameras数组
                data.cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.index;
                    option.text = `Camera ${camera.index} (${camera.width}x${camera.height} @ ${camera.fps}fps)`;
                    if (camera.index === currentCamera) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                switchButton.disabled = false;

            } catch (error) {
                showError('Error loading cameras: ' + error.message);
            } finally {
                // 重新启用刷新按钮
                document.getElementById('refreshButton').disabled = false;
            }
        }

        async function switchCamera() {
            const select = document.getElementById('cameraSelect');
            const cameraIndex = parseInt(select.value);

            if (isNaN(cameraIndex)) {
                showError('Please select a camera');
                return;
            }

            try {
                document.getElementById('switchButton').disabled = true;
                document.getElementById('refreshButton').disabled = true;

                const response = await fetch("{{ url_for('main.switch_camera') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({camera_index: cameraIndex})
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to switch camera');
                }

                // 更新当前摄像头
                currentCamera = cameraIndex;

                // 刷新视频源
                const videoFeed = document.getElementById('videoFeed');
                videoFeed.src = "{{ url_for('main.video_feed') }}?" + new Date().getTime();

                hideError();

            } catch (error) {
                showError('Error switching camera: ' + error.message);
            } finally {
                document.getElementById('switchButton').disabled = false;
                document.getElementById('refreshButton').disabled = false;
            }
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            const error = document.getElementById('error');
            error.style.display = 'none';
        }

        async function updateStatus() {
            try {
                const response = await fetch("{{ url_for('main.get_status') }}");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const status = await response.json();

                // 更新状态显示
                const statusDiv = document.getElementById('status');
                if (status.error) {
                    statusDiv.innerHTML = `
                <p class="error">Error: ${status.error}</p>
            `;
                    return;
                }

                statusDiv.innerHTML = `
                    <p>Status: ${status.is_running ? 'Running' : 'Stopped'}</p>
                    <p>Camera: ${status.current_camera !== null ? status.current_camera : 'None'}</p>
                    <p>Resolution: ${status.camera_info.width || 0}x${status.camera_info.height || 0}</p>
                    <p>FPS: ${status.fps || 0}</p>
                `;

                // 如果摄像头未初始化，显示警告
                if (!status.camera_info.initialized) {
                    statusDiv.innerHTML += `
                        <p class="warning">Camera not initialized</p>
                    `;
                }

            } catch (error) {
                console.error('Error updating status:', error);
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `
                    <p class="error">Error updating status: ${error.message}</p>
                `;
            }
        }

        // 定期更新状态
        function startStatusUpdates() {
            // 立即更新一次
            updateStatus();
            // 然后每秒更新一次
            setInterval(updateStatus, 1000);
        }

        // 页面加载完成后启动状态更新
        document.addEventListener('DOMContentLoaded', () => {
            loadCameras();
            startStatusUpdates();
        });

        // 添加样式
        const style = document.createElement('style');
        style.textContent = `
            .status {
                margin: 20px;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background-color: #f9f9f9;
            }

            .status p {
                margin: 5px 0;
                font-size: 14px;
            }

            .status .error {
                color: #dc3545;
                font-weight: bold;
            }

            .status .warning {
                color: #ffc107;
                font-weight: bold;
            }
        `;
        document.head.appendChild(style);
    </script>
<!--?    <script src="{{ url_for('static', filename='/js/main.js') }}"></script>-->
</body>
</html>